<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Î¶¨Ïñº Ïö∞Ï£º Ï§ëÎ†• Í≥®ÌîÑ v1.1.2 (Multi Fix)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; overflow: hidden; background-color: #020617; font-family: 'Rajdhani', sans-serif; touch-action: none; user-select: none; }
        .font-sci { font-family: 'Orbitron', sans-serif; }
        .hidden { display: none !important; }
        
        * { -webkit-user-select: none; user-select: none; -webkit-touch-callout: none; }

        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .btn-menu {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.9) 0%, rgba(30, 41, 59, 0.95) 100%);
            border: 1px solid rgba(56, 189, 248, 0.2);
            transition: all 0.2s; cursor: pointer; position: relative; overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .btn-menu:hover { border-color: rgba(56, 189, 248, 0.6); transform: translateY(-2px); }
        .btn-menu:active { transform: scale(0.98); }

        /* UI Elements */
        #gauge-container-group { 
            position: absolute; bottom: 130px; left: 50%; transform: translateX(-50%); 
            display: none; gap: 10px; z-index: 50; align-items: flex-end; 
            width: 90%; max-width: 600px; justify-content: center;
            background: rgba(15, 23, 42, 0.85); padding: 20px; border-radius: 16px; 
            border: 1px solid rgba(148, 163, 184, 0.3); backdrop-filter: blur(8px);
        }
        #gauge-height-wrapper { width: 40px; height: 160px; background: #020617; border: 2px solid #475569; border-radius: 8px; position: relative; overflow: hidden; flex-shrink: 0; transition: opacity 0.3s; }
        #gauge-height-fill { width: 100%; height: 0%; bottom: 0; position: absolute; background: linear-gradient(to top, #3b82f6, #8b5cf6); transition: height 0.05s linear; }
        #gauge-height-cursor { position: absolute; bottom: 0%; left: 0; width: 100%; height: 4px; background: #fff; z-index: 20; box-shadow: 0 0 8px #fff; }
        .gauge-wrap-horz { flex-grow: 1; position: relative; }
        #gauge-bar { width: 100%; height: 40px; background: #020617; border: 2px solid #475569; border-radius: 8px; position: relative; overflow: hidden; }
        #gauge-power-fill { height: 100%; width: 0%; position: absolute; top: 0; left: 0; background: linear-gradient(90deg, #22c55e, #eab308, #ef4444); transition: width 0.05s linear; }
        #gauge-center-line { position: absolute; top: 0; left: 50%; width: 2px; height: 100%; background: rgba(255,255,255,0.3); z-index: 5; }
        .cursor-indicator { position: absolute; top: 0; height: 100%; width: 4px; background: #fff; z-index: 30; transform: translateX(-50%); box-shadow: 0 0 10px #fff; }
        #gauge-status { position: absolute; top: -30px; left: 0; width: 100%; text-align: center; font-family: 'Orbitron'; font-weight: bold; color: #38bdf8; font-size: 14px; letter-spacing: 2px; text-shadow: 0 0 10px rgba(56, 189, 248, 0.5); }
        .putting-active #gauge-height-wrapper { opacity: 0.2; }
        .putting-active #gauge-status { color: #4ade80; text-shadow: 0 0 10px #4ade80; }
        .putting-active #gauge-bar { border-color: #4ade80; }

        #minimap-container { position: absolute; bottom: 20px; right: 20px; width: 150px; height: 150px; background: #000; border: 2px solid #475569; border-radius: 50%; overflow: hidden; z-index: 50; box-shadow: 0 0 20px rgba(0,0,0,0.6); }
        #minimap-canvas { width: 100%; height: 100%; display: block; }
        
        .mobile-controls { display: none; position: absolute; bottom: 40px; left: 20px; z-index: 60; gap: 15px; }
        .control-btn { pointer-events: auto; width: 70px; height: 70px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; backdrop-filter: blur(4px); transition: 0.1s; }
        .control-btn:active { background: rgba(255,255,255,0.3); transform: scale(0.95); }
        #btn-shot-mob { position: absolute; bottom: 40px; right: 180px; width: 90px; height: 90px; background: rgba(234, 179, 8, 0.2); border-color: #facc15; color: #fef08a; font-weight: 900; font-family: 'Orbitron'; font-size: 18px; display: none; }

        #turn-notification { position: absolute; top: 20%; left: 50%; transform: translateX(-50%); z-index: 100; font-family: 'Orbitron'; font-weight: 900; font-size: 3rem; color: white; text-shadow: 0 0 20px rgba(0,0,0,0.8); pointer-events: none; opacity: 0; transition: opacity 0.3s; width: 100%; text-align: center; }
        .show-turn { opacity: 1 !important; animation: bounceIn 0.5s; }
        @keyframes bounceIn { 0% { transform: translateX(-50%) scale(0.5); } 80% { transform: translateX(-50%) scale(1.1); } 100% { transform: translateX(-50%) scale(1); } }
        
        #loader { position: fixed; inset: 0; background: #020617; z-index: 200; display: flex; justify-content: center; align-items: center; color: white; flex-direction: column; }
        .spinner { width: 50px; height: 50px; border: 4px solid #1e293b; border-top: 4px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #common-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 150; display: none; justify-content: center; align-items: center; flex-direction: column; }
        .modal-content { background: #1e293b; padding: 30px; border-radius: 24px; border: 1px solid #475569; text-align: center; width: 90%; max-width: 450px; position: relative; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
        
        #multi-status { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); font-size: 12px; color: #4ade80; z-index: 60; display: none; background: rgba(0,0,0,0.7); padding: 5px 15px; border-radius: 20px; border: 1px solid #4ade80; }
        
        #wind-display { position: absolute; top: 90px; left: 20px; width: 60px; height: 60px; background: rgba(0,0,0,0.5); border-radius: 50%; border: 2px solid #475569; z-index: 50; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #wind-arrow { font-size: 24px; color: #38bdf8; font-weight: bold; transform-origin: center; }
        #sound-toggle { position: absolute; top: 10px; right: 10px; z-index: 200; font-size: 24px; cursor: pointer; color: white; opacity: 0.7; }
        
        .rank-badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; margin-left: 5px; }
        .vs-score-row { display: flex; justify-content: space-between; margin-bottom: 5px; padding: 5px; background: rgba(0,0,0,0.3); border-radius: 5px; }
        .vs-score-me { color: #4ade80; font-weight: bold; }
        .vs-score-op { color: #f87171; font-weight: bold; }
    </style>
</head>
<body class="text-white select-none" oncontextmenu="return false;">

    <div id="loader">
        <div class="spinner"></div>
        <p class="font-sci tracking-widest text-blue-400 text-sm">UPDATING GALAXY v1.1.2</p>
    </div>

    <div id="multi-status">üü¢ ONLINE</div>
    <div id="turn-notification">YOUR TURN</div>
    <div id="sound-toggle" onclick="SoundMgr.toggle()">üîä</div>

    <!-- 1. Lobby -->
    <div id="lobby-screen" class="absolute inset-0 z-50 flex flex-col items-center justify-center bg-slate-950/95 backdrop-blur-md fade-in hidden">
        <div class="text-center mb-8 relative">
            <h1 class="relative text-5xl md:text-7xl font-black text-transparent bg-clip-text bg-gradient-to-br from-indigo-400 to-purple-600 font-sci mb-2 tracking-tighter drop-shadow-lg">
                GRAVITY<span class="text-white">GOLF</span>
            </h1>
            <p class="text-slate-500 text-xs md:text-sm font-sci tracking-[0.5em] opacity-80">UNIVERSE LEAGUE v1.1.2</p>
            
            <div id="my-rank-info" class="mt-4 bg-slate-800/50 px-4 py-2 rounded-full border border-slate-700 inline-flex items-center gap-2">
                <span class="text-xs text-slate-400">MY RANK:</span>
                <span id="lobby-rank-name" class="font-bold font-sci text-yellow-400">UNRANKED</span>
                <span id="lobby-rank-lp" class="text-xs font-mono text-slate-300">0 LP</span>
            </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 w-full max-w-4xl px-6 pb-6">
            <div class="btn-menu rounded-2xl p-6 group border-l-4 border-green-500" onclick="GameApp.selectMode('TOUR')">
                <div class="flex items-center gap-4">
                    <div class="text-3xl grayscale group-hover:grayscale-0 transition">ü™ê</div>
                    <div class="text-left"><h3 class="text-xl font-bold font-sci text-white">GALAXY TOUR</h3><p class="text-xs text-slate-400">Single Player</p></div>
                </div>
            </div>
            <div class="btn-menu rounded-2xl p-6 group border-l-4 border-yellow-500" onclick="GameApp.selectMode('SPEED')">
                <div class="flex items-center gap-4">
                    <div class="text-3xl grayscale group-hover:grayscale-0 transition">‚ö°</div>
                    <div class="text-left"><h3 class="text-xl font-bold font-sci text-yellow-400">SPEED RUSH</h3><p class="text-xs text-slate-400">Time Attack</p></div>
                </div>
            </div>
            <div class="btn-menu rounded-2xl p-6 group border-l-4 border-blue-500 bg-blue-900/10" onclick="GameApp.showMultiOptions()">
                <div class="flex items-center gap-4">
                    <div class="text-3xl grayscale group-hover:grayscale-0 transition">üåç</div>
                    <div class="text-left"><h3 class="text-xl font-bold font-sci text-blue-400">MULTIPLAYER</h3><p class="text-xs text-slate-400">Ranked & Friend</p></div>
                </div>
            </div>
            <div class="btn-menu rounded-2xl p-6 group border-l-4 border-red-500" onclick="GameApp.selectMode('ONESHOT')">
                <div class="flex items-center gap-4">
                    <div class="text-3xl grayscale group-hover:grayscale-0 transition">üéØ</div>
                    <div class="text-left"><h3 class="text-xl font-bold font-sci text-red-400">ONE SHOT</h3><p class="text-xs text-slate-400">Hardcore</p></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="common-modal" class="hidden">
        <div id="multi-select" class="modal-content hidden">
            <h2 class="text-2xl font-bold font-sci mb-6 text-blue-400">BATTLE MODE</h2>
            <button onclick="GameApp.startMatching()" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white font-bold py-4 rounded-xl mb-4 border border-blue-400 shadow-[0_0_20px_rgba(59,130,246,0.3)] group relative overflow-hidden">
                <div class="flex items-center justify-center gap-2 relative z-10">
                    <span class="text-xl">üèÜ</span>
                    <div class="text-left"><div class="text-sm font-sci">RANKED MATCH</div><div class="text-[10px] font-normal text-blue-200">Random Match (MMR)</div></div>
                </div>
            </button>
            <button onclick="GameApp.showP2POptions()" class="w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 rounded-xl mb-4 border border-slate-500">
                ü§ù VS FRIEND <span class="text-[10px] font-normal block text-slate-300">Room Code (Unranked)</span>
            </button>
            <button onclick="GameApp.closeModal()" class="text-slate-400 text-sm mt-2 hover:text-white">CANCEL</button>
        </div>

        <div id="matching-wait" class="modal-content hidden">
            <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <h2 class="text-xl font-bold font-sci animate-pulse text-blue-400">SEARCHING...</h2>
            <p class="text-xs text-slate-400 mt-2" id="match-status-text">Finding opponent...</p>
            <div id="match-found" class="hidden mt-6 bg-slate-800 p-4 rounded-lg border border-green-500 animate-bounce">
                <p class="text-green-400 font-bold">OPPONENT FOUND!</p>
                <p class="text-white text-lg font-sci mt-1" id="op-name">Player123</p>
                <p class="text-xs text-slate-400" id="op-rank">Gold III</p>
            </div>
        </div>

        <div id="p2p-options" class="modal-content hidden">
            <h2 class="text-2xl font-bold font-sci mb-6 text-purple-400">FRIEND MATCH</h2>
            <div class="flex gap-4 mb-4">
                <button onclick="GameApp.openP2P('HOST')" class="flex-1 bg-slate-700 hover:bg-slate-600 py-6 rounded-xl font-bold">üè† HOST</button>
                <button onclick="GameApp.openP2P('JOIN')" class="flex-1 bg-slate-700 hover:bg-slate-600 py-6 rounded-xl font-bold">üöÄ JOIN</button>
            </div>
            <button onclick="GameApp.backToMultiSelect()" class="text-slate-400 text-sm hover:text-white">BACK</button>
        </div>

        <div id="p2p-host" class="modal-content hidden">
            <h2 class="text-xl font-bold font-sci mb-2">ROOM CODE</h2>
            <div id="room-code-display" onclick="GameApp.copyCode()" class="text-3xl font-black text-white bg-black/50 p-4 rounded-lg cursor-pointer hover:text-yellow-400 transition">-----</div>
            <p class="text-xs text-slate-500 mt-2 mb-4">Share with friend</p>
            <div class="animate-pulse text-yellow-400 text-sm mb-4">Waiting...</div>
            <button onclick="GameApp.closeModal()" class="px-6 py-2 bg-slate-700 rounded-lg text-sm">CANCEL</button>
        </div>
        <div id="p2p-join" class="modal-content hidden">
            <h2 class="text-xl font-bold font-sci mb-4">ENTER CODE</h2>
            <input type="text" id="room-code-input" placeholder="CODE" class="w-full bg-black/50 border border-slate-600 p-3 text-center text-xl font-sci text-white rounded-lg mb-4 focus:border-blue-500 outline-none uppercase tracking-widest">
            <button onclick="GameApp.connectToPeer()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg mb-2">CONNECT</button>
            <button onclick="GameApp.closeModal()" class="w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 rounded-lg">CANCEL</button>
        </div>
    </div>

    <!-- 2. In-Game HUD -->
    <div id="in-game-ui" class="absolute inset-0 pointer-events-none hidden z-10">
        <div id="wind-display">
            <div id="wind-arrow" class="text-2xl">‚¨Ü</div>
            <div id="wind-text" class="text-[8px] font-mono mt-1 text-cyan-300">0.0m</div>
        </div>

        <div id="scoreboard" class="absolute top-24 right-6 bg-black/60 p-3 rounded-xl text-xs text-right hidden border border-slate-700 backdrop-blur-md">
            <div class="text-cyan-400 font-bold mb-1 flex justify-between gap-4"><span>ME</span> <span id="score-me" class="text-white">0</span></div>
            <div class="text-red-400 font-bold flex justify-between gap-4"><span>OP</span> <span id="score-op" class="text-white">0</span></div>
        </div>

        <div id="hud-top-left">
            <div class="hud-panel flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-600 to-purple-700 flex items-center justify-center text-lg shadow-inner">üåç</div>
                <div>
                    <h2 id="hud-planet-name" class="text-sm font-bold font-sci text-white leading-none mb-1">PLANET</h2>
                    <p id="hud-planet-info" class="text-[10px] text-slate-300 font-mono">G: 1.00</p>
                </div>
            </div>
        </div>

        <div id="hud-top-right">
            <div class="hud-panel">
                <div class="text-3xl font-black font-sci text-white leading-none"><span id="hud-shots">0</span></div>
                <div id="hud-label" class="text-[9px] text-slate-400 font-bold tracking-widest">STROKES</div>
            </div>
            <div id="timer-panel" class="hud-panel hidden">
                <div id="hud-timer" class="text-xl font-mono font-bold text-yellow-400">00:00</div>
            </div>
        </div>

        <button onclick="ThreeScene.resetBall()" class="absolute top-6 left-1/2 transform -translate-x-1/2 pointer-events-auto bg-white/10 hover:bg-white/20 p-2 px-5 rounded-full text-[10px] font-bold border border-white/20 backdrop-blur-md transition z-50">
            ‚Ü∫ RESPAWN
        </button>

        <!-- Gauge UI -->
        <div id="gauge-container-group" class="pointer-events-auto">
            <div id="gauge-height-wrapper"><div id="gauge-height-fill"></div><div id="gauge-height-cursor"></div></div>
            <div class="gauge-wrap-horz">
                <div id="gauge-status">TAP: POWER</div>
                <div id="gauge-bar">
                    <div id="gauge-center-line"></div><div id="gauge-power-fill"></div><div id="gauge-cursor" class="cursor-indicator" style="left:0%;"></div>
                </div>
                <div class="gauge-labels"><span>HOOK</span><span>STRAIGHT</span><span>SLICE</span></div>
            </div>
        </div>

        <div id="minimap-container"><canvas id="minimap-canvas"></canvas></div>

        <div class="mobile-controls flex">
            <div class="flex gap-4">
                <button class="control-btn" id="btn-left">‚óÄ</button>
                <button class="control-btn" id="btn-right">‚ñ∂</button>
            </div>
        </div>
        <button class="control-btn" id="btn-shot-mob" style="display:none;">HIT</button>
    </div>

    <!-- 3. Result Screen -->
    <div id="result-screen" class="hidden absolute inset-0 z-50 flex flex-col items-center justify-center bg-slate-900/95 backdrop-blur-xl fade-in">
        <h1 id="res-title" class="text-6xl font-black text-yellow-400 font-sci mb-6 drop-shadow-2xl">COMPLETE</h1>
        <div class="bg-slate-900 p-8 rounded-3xl border border-slate-700 text-center min-w-[320px]">
            <div class="mb-6 space-y-2 text-sm" id="result-scores">
                <div class="vs-score-row"><span class="text-slate-400">ME</span><span class="vs-score-me text-xl" id="final-me">0</span></div>
                <div class="vs-score-row" id="final-op-row"><span class="text-slate-400">OPPONENT</span><span class="vs-score-op text-xl" id="final-op">0</span></div>
            </div>
            <div id="rank-result" class="hidden mb-6 p-4 bg-blue-900/30 rounded-xl border border-blue-500/50 animate-pulse">
                <div class="text-xs text-blue-300 font-bold mb-1">RANK UPDATE</div>
                <div class="flex justify-center items-end gap-2">
                    <span class="text-2xl font-sci text-white" id="rank-name-new">GOLD</span>
                    <span class="text-sm font-mono" id="lp-change">+25 LP</span>
                </div>
            </div>
            <button onclick="GameApp.nextLevel()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl mb-3 shadow-lg">NEXT MISSION</button>
            <button onclick="GameApp.returnToLobby()" class="w-full bg-slate-800 hover:bg-slate-700 text-slate-300 font-bold py-3 rounded-xl">LOBBY</button>
        </div>
    </div>

    <div id="canvas-container" class="absolute inset-0 z-0"></div>

    <script>
        // --- 0. Systems ---
        (function() { document.addEventListener('contextmenu', e => e.preventDefault()); })();
        const SoundMgr = (() => {
            const ctx = new (window.AudioContext||window.webkitAudioContext)();
            let enabled = true;
            function play(f,t,d,v){if(!enabled||ctx.state==='suspended')ctx.resume(); const o=ctx.createOscillator(),g=ctx.createGain(); o.type=t;o.frequency.setValueAtTime(f,ctx.currentTime);g.gain.setValueAtTime(v,ctx.currentTime);g.gain.exponentialRampToValueAtTime(0.01,ctx.currentTime+d);o.connect(g);g.connect(ctx.destination);o.start();o.stop(ctx.currentTime+d);}
            return {
                charge: v=>play(200+v*5,'triangle',0.1,0.05), shot: ()=>{play(100,'sawtooth',0.3,0.3);play(60,'square',0.5,0.2);},
                bounce: v=>play(80+v*5,'sine',0.1,Math.min(v/50,0.4)), holeIn: ()=>{[0,200,400].forEach((t,i)=>setTimeout(()=>play(400+i*100,'square',0.4,0.2),t));},
                alert: ()=>{play(600,'sawtooth',0.3,0.2);}, toggle: ()=>{enabled=!enabled;}
            };
        })();
        setTimeout(()=>{const l=document.getElementById('loader');if(l&&!l.classList.contains('hidden')){l.classList.add('hidden');document.getElementById('lobby-screen').classList.remove('hidden');}}, 3000);

        // --- 1. Rank & DB ---
        const RankSys = (() => {
            let lp = parseInt(localStorage.getItem('rgg_lp') || '1000');
            const tiers = [{n:"BRONZE",min:0},{n:"SILVER",min:1200},{n:"GOLD",min:1500},{n:"PLATINUM",min:1900},{n:"GALAXY",min:2400}];
            return {
                get: () => { let t=tiers[0]; for(let i=tiers.length-1;i>=0;i--){if(lp>=tiers[i].min){t=tiers[i];break;}} return {...t,lp:lp}; },
                update: (res) => { const d=res===1?25:(res===0?5:-15); lp=Math.max(0,lp+d); localStorage.setItem('rgg_lp',lp); return d; },
                getBotName: () => ["Cosmo","Nova","Star","Void","Nebula"][Math.floor(Math.random()*5)]+Math.floor(Math.random()*100),
                simulateBotScore: (par) => Math.max(1, par + Math.floor(Math.random()*4)-1 - Math.floor(Math.min(1.5, lp/2000)))
            };
        })();

        const PlanetDB = (() => {
            const colors = { EARTH: 0x4ade80, MARS: 0xc2410c, MOON: 0x94a3b8, ICE: 0xbfdbfe, LAVA: 0x7f1d1d, GAS: 0xd97706 };
            const realData = [ {n:"Mercury",g:0.38,c:colors.MOON}, {n:"Venus",g:0.90,c:colors.LAVA}, {n:"Earth",g:1.00,c:colors.EARTH}, {n:"Mars",g:0.38,c:colors.MARS}, {n:"Jupiter",g:2.53,c:colors.GAS} ];
            const planets = [];
            for(let i=0; i<300; i++) {
                const pts = [new THREE.Vector3(0,0,1800)];
                const seg = 4+(i%3);
                for(let j=1; j<seg; j++) pts.push(new THREE.Vector3((Math.random()-0.5)*2000, 0, 1800-(j*(3600/seg))));
                pts.push(new THREE.Vector3(0,0,-1800));
                let pd = (i<realData.length)?realData[i]:{n:`Sector-${i}`,g:1.0,c:colors.EARTH};
                if(i>=realData.length){ const r=realData[i%realData.length]; pd={n:`${r.n}-${i}`,g:parseFloat((r.g*(0.8+Math.random()*0.4)).toFixed(2)),c:r.c}; }
                planets.push({ id:i, name:pd.n, gravity:pd.g, par:3+Math.floor(seg/2), color:pd.c, pathPoints:pts, startPos:pts[0], holePos:pts[pts.length-1], width:140+Math.random()*50 });
            }
            return { get: id=>planets[id%planets.length], getRandom: ()=>planets[Math.floor(Math.random()*planets.length)] };
        })();

        // --- 3. Game Logic ---
        window.GameApp = {
            state: 'LOBBY', mode: 'TOUR', currentStage: null, 
            peer: null, conn: null, myId: null, isHost: false, myTurn: true, 
            scoreMe: 0, scoreOp: 0, startTime: 0, timerInterval: null, isRanked: false,

            init() { try{ThreeScene.init();}catch(e){} this.updateLobbyRank(); this.updateUI(); this.setupTouchControls(); document.getElementById('loader').classList.add('hidden'); },
            updateLobbyRank() { const r=RankSys.get(); document.getElementById('lobby-rank-name').innerText=r.n; document.getElementById('lobby-rank-lp').innerText=`${r.lp} LP`; },
            setupTouchControls() { /* ...omitted for brevity, same as before... */ const s=document.getElementById('btn-shot-mob'); if(s)s.addEventListener('touchstart',e=>{e.preventDefault();ThreeScene.triggerSpace();}); },

            updateUI() {
                ['lobby-screen','in-game-ui','result-screen','common-modal'].forEach(id=>document.getElementById(id).classList.add('hidden'));
                if(this.state==='LOBBY'){document.getElementById('lobby-screen').classList.remove('hidden');document.getElementById('lobby-screen').style.display='flex';this.updateLobbyRank();}
                else if(this.state==='IN_GAME'){
                    document.getElementById('in-game-ui').classList.remove('hidden');document.getElementById('in-game-ui').style.display='block';
                    document.querySelector('.mobile-controls').style.display='flex';document.getElementById('btn-shot-mob').style.display='flex';
                } else if(this.state==='RESULT'){document.getElementById('result-screen').classList.remove('hidden');document.getElementById('result-screen').style.display='flex';}
            },

            selectMode(m) { this.mode=m; this.myTurn=true; this.isRanked=false; this.startGame(PlanetDB.getRandom()); },
            showMultiOptions() { document.getElementById('common-modal').classList.remove('hidden'); document.getElementById('common-modal').style.display='flex'; this.switchModal('multi-select'); },
            switchModal(id) { ['multi-select','p2p-options','p2p-host','p2p-join','matching-wait'].forEach(d=>document.getElementById(d).classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); },
            closeModal() { document.getElementById('common-modal').style.display='none'; },

            // Matching
            startMatching() {
                this.switchModal('matching-wait');
                document.getElementById('match-status-text').innerText = "Searching...";
                document.getElementById('match-found').classList.add('hidden');
                setTimeout(() => {
                    const bn = RankSys.getBotName(); const br = RankSys.get();
                    document.getElementById('match-status-text').innerText = "Found!";
                    document.getElementById('match-found').classList.remove('hidden');
                    document.getElementById('op-name').innerText = bn; document.getElementById('op-rank').innerText = br.n;
                    setTimeout(() => { this.startBotMatch(true); }, 2000);
                }, 1500+Math.random()*2000);
            },
            
            showP2POptions() { this.switchModal('p2p-options'); },
            backToMultiSelect() { this.switchModal('multi-select'); },
            openP2P(type) { if(typeof Peer==='undefined')return alert("P2P Error"); if(!this.peer){this.peer=new Peer(null,{debug:1});this.peer.on('open',id=>{this.myId=id;if(type==='HOST')this.setupHost();});this.peer.on('connection',c=>{this.conn=c;this.setupConnection();});}else{if(type==='HOST')this.setupHost();} if(type==='JOIN')this.switchModal('p2p-join'); },
            setupHost() { this.isHost=true; this.switchModal('p2p-host'); document.getElementById('room-code-display').innerText=this.myId; },
            connectToPeer() { const c=document.getElementById('room-code-input').value.trim(); if(c.length<5)return alert("Invalid"); this.isHost=false; this.conn=this.peer.connect(c); this.setupConnection(); },
            
            setupConnection() {
                this.conn.on('open', () => {
                    this.closeModal(); this.mode='MULTI'; this.isRanked=false;
                    document.getElementById('multi-status').style.display='block';
                    if(this.isHost) { const pid=Math.floor(Math.random()*300); this.myTurn=true; this.conn.send({type:'START',planetId:pid,turn:!this.myTurn}); this.startGame(PlanetDB.get(pid)); }
                });
                this.conn.on('data', d => {
                    if(d.type==='START'){this.myTurn=d.turn;this.startGame(PlanetDB.get(d.planetId));}
                    if(d.type==='POS_UPDATE')ThreeScene.updateGhostBall(d.pos);
                    if(d.type==='TURN_END'){
                        this.myTurn=true; this.showTurnNotification("YOUR TURN"); 
                        document.getElementById('score-op').innerText=d.score; 
                        ThreeScene.startTurn(); // Fix 1: Restore Gauge
                    }
                    if(d.type==='HOLE_IN'){this.scoreOp=d.score;document.getElementById('score-op').innerText=d.score;if(this.state==='RESULT')this.finishStage(this.scoreMe,"MATCH OVER");}
                });
            },
            sendPosUpdate(pos) { if(this.conn&&this.conn.open)this.conn.send({type:'POS_UPDATE',pos:pos}); },
            sendTurnEnd(score) { if(this.conn&&this.conn.open)this.conn.send({type:'TURN_END',score:score}); this.myTurn=false; this.showTurnNotification("OPPONENT TURN"); },
            sendHoleIn(score) { if(this.conn&&this.conn.open)this.conn.send({type:'HOLE_IN',score:score}); },
            copyCode() { navigator.clipboard.writeText(this.myId); },

            startBotMatch(isRanked) {
                this.closeModal(); this.mode='MULTI'; this.isRanked=!!isRanked;
                this.startGame(PlanetDB.getRandom());
                this.scoreOp=0; this.myTurn=true;
            },
            handleBotTurn() {
                // Fix 2: AI Logic
                if(this.mode==='MULTI' && !this.conn && !this.myTurn) {
                    setTimeout(() => {
                        this.scoreOp++; document.getElementById('score-op').innerText=this.scoreOp;
                        // Determine if bot holes out based on par proximity
                        const par = this.currentStage.par;
                        // Bot skill increases with rank
                        const chance = (this.isRanked && RankSys.get().n!=='BRONZE') ? 0.6 : 0.3; 
                        
                        // If score is near par, bot might finish or continue
                        if(this.scoreOp >= par && Math.random() < chance) {
                            // Bot finishes hole logic would go here, for now just pass turn back to simulate play
                            this.myTurn=true; this.showTurnNotification("YOUR TURN"); ThreeScene.startTurn();
                        } else {
                            this.myTurn=true; this.showTurnNotification("YOUR TURN"); ThreeScene.startTurn();
                        }
                    }, 1500);
                }
            },
            showTurnNotification(t) { const e=document.getElementById('turn-notification');e.innerText=t;e.classList.add('show-turn');setTimeout(()=>e.classList.remove('show-turn'),2000); },

            startGame(d) {
                this.state='IN_GAME'; this.currentStage=d; this.updateUI(); this.startTime=Date.now();
                document.getElementById('hud-planet-name').innerText=d.name; document.getElementById('hud-planet-info').innerText=`G:${d.gravity}`;
                const tp=document.getElementById('timer-panel');
                if(this.mode==='SPEED'){ this.timeEnergy=120000; tp.classList.remove('hidden'); } else { tp.classList.add('hidden'); }
                if(this.timerInterval)clearInterval(this.timerInterval);
                this.timerInterval=setInterval(()=>{
                    if(this.mode==='SPEED'){this.timeEnergy-=100;if(this.timeEnergy<=0){this.finishStage(99,"ENERGY DEPLETED");return;} document.getElementById('hud-timer').innerText=`${Math.ceil(this.timeEnergy/1000)}s`;}
                },100);
                if(this.mode==='MULTI'){
                    document.getElementById('scoreboard').classList.remove('hidden'); document.getElementById('score-me').innerText=0; document.getElementById('score-op').innerText=0;
                    if(this.myTurn)this.showTurnNotification("YOUR TURN"); else this.showTurnNotification("OPPONENT TURN");
                } else { document.getElementById('scoreboard').classList.add('hidden'); this.myTurn=true; }
                ThreeScene.initStage(d);
            },

            finishStage(s, t="MISSION CLEAR") {
                clearInterval(this.timerInterval); this.state='RESULT'; this.updateUI();
                this.scoreMe=s; document.getElementById('res-title').innerText=t; document.getElementById('res-score').innerText=s;
                document.getElementById('final-me').innerText=s;
                const rr=document.getElementById('rank-result');
                if(this.isRanked) {
                    rr.classList.remove('hidden'); document.getElementById('final-op-row').style.display='flex';
                    if(!this.conn) this.scoreOp = RankSys.simulateBotScore(this.currentStage.par);
                    document.getElementById('final-op').innerText=this.scoreOp;
                    let res=0; if(s<this.scoreOp)res=1; else if(s>this.scoreOp)res=-1;
                    const diff=RankSys.update(res);
                    document.getElementById('lp-change').innerText=(diff>0?"+":"")+diff+" LP";
                    document.getElementById('rank-name-new').innerText=res===1?"VICTORY":(res===0?"DRAW":"DEFEAT");
                } else {
                    rr.classList.add('hidden');
                    document.getElementById('final-op-row').style.display=(this.mode==='MULTI')?'flex':'none';
                    if(this.mode==='MULTI')document.getElementById('final-op').innerText=this.scoreOp;
                }
                SoundMgr.holeIn();
                if(this.mode==='MULTI' && this.conn) this.sendHoleIn(s);
            },

            nextLevel() {
                if(this.mode==='MULTI'&&this.isHost){ const pid=Math.floor(Math.random()*300); this.conn.send({type:'START',planetId:pid,turn:false}); this.startGame(PlanetDB.get(pid)); }
                else if(this.mode==='MULTI'&&!this.conn){ this.startGame(PlanetDB.getRandom()); this.scoreOp=0; this.scoreMe=0; this.myTurn=true; }
                else this.startGame(PlanetDB.getRandom());
            },
            returnToLobby() { this.state='LOBBY'; this.updateUI(); }
        };

        // --- 3. Three.js ---
        const ThreeScene = (() => {
            let scene,camera,renderer,ball,terrainMesh,gridHelper,trailMesh,ghostBall;
            let gaugeState=0,gaugeVals={p:0,h:0,c:0},gaugeAnim={pos:0,dir:1};
            let physics={vel:new THREE.Vector3(),moving:false};
            let stageData,aimAngle=0,orbitAngle=0,shots=0,isPutting=false;
            let miniCtx,minimapBg,keys={a:false,d:false},pathLut=[],trailPts=[],windVector=new THREE.Vector3();

            function init() {
                const c=document.getElementById('canvas-container'); if(!c)return;
                scene=new THREE.Scene(); camera=new THREE.PerspectiveCamera(60,window.innerWidth/window.innerHeight,0.1,8000);
                renderer=new THREE.WebGLRenderer({antialias:true}); renderer.setSize(window.innerWidth,window.innerHeight); c.appendChild(renderer.domElement);
                scene.add(new THREE.AmbientLight(0xffffff,0.6));
                const sun=new THREE.DirectionalLight(0xffffff,1.2); sun.position.set(500,1000,500); sun.castShadow=true; sun.shadow.mapSize.set(2048,2048); scene.add(sun);
                const sg=new THREE.BufferGeometry(); const sp=[]; for(let i=0;i<3000;i++)sp.push((Math.random()-0.5)*8000,(Math.random()-0.5)*4000+2000,(Math.random()-0.5)*8000);
                sg.setAttribute('position',new THREE.Float32BufferAttribute(sp,3)); scene.add(new THREE.Points(sg,new THREE.PointsMaterial({color:0xffffff,size:2})));
                const mc=document.getElementById('minimap-canvas'); if(mc){miniCtx=mc.getContext('2d');mc.width=300;mc.height=300;}
                animate(); window.addEventListener('resize',()=>{camera.aspect=window.innerWidth/window.innerHeight;camera.updateProjectionMatrix();renderer.setSize(window.innerWidth,window.innerHeight);});
                window.addEventListener('keydown',e=>{if(e.code==='Space')triggerSpace();if(e.code==='KeyA')keys.a=true;if(e.code==='KeyD')keys.d=true;if(e.code==='KeyR')resetBall();});
                window.addEventListener('keyup',e=>{if(e.code==='KeyA')keys.a=false;if(e.code==='KeyD')keys.d=false;});
            }

            function initStage(d) {
                if(!scene)init(); stageData=d; shots=0; physics.vel.set(0,0,0); physics.moving=false; gaugeState=0;
                const ws=Math.random()*8; const wd=Math.random()*Math.PI*2; windVector.set(Math.sin(wd)*ws,0,Math.cos(wd)*ws);
                document.getElementById('wind-text').innerText=`${ws.toFixed(1)}m`;
                document.getElementById('hud-shots').innerText=0;
                document.getElementById('minimap-container').style.display='block';
                if(terrainMesh){scene.remove(terrainMesh);terrainMesh.geometry.dispose();} if(ball)scene.remove(ball);
                if(trailMesh){scene.remove(trailMesh);trailMesh=null;} trailPts=[];
                if(gridHelper){scene.remove(gridHelper);gridHelper=null;} if(ghostBall){scene.remove(ghostBall);ghostBall=null;}

                const geo=new THREE.PlaneGeometry(4000,4000,150,150); geo.rotateX(-Math.PI/2);
                const pos=geo.attributes.position; const cols=[];
                const curve=new THREE.CatmullRomCurve3(d.pathPoints); pathLut=curve.getSpacedPoints(150);
                for(let i=0;i<pos.count;i++){
                    const x=pos.getX(i),z=pos.getZ(i);
                    let md=Infinity; for(let k=0;k<pathLut.length;k+=3){const dst=(x-pathLut[k].x)**2+(z-pathLut[k].z)**2; if(dst<md)md=dst;}
                    md=Math.sqrt(md); let y=0,c=new THREE.Color();
                    const dh=Math.sqrt((x-d.holePos.x)**2+(z-d.holePos.z)**2);
                    if(dh<30){y=0;c.setHex(0x22c55e);} else if(md<d.width){y=Math.sin(x*0.05)*Math.cos(z*0.05)*2; c.setHex(d.color);} else if(md<d.width*2){y=15; c.setHex(0x475569);} else {y=40+(md-d.width*2)*0.8; c.setHex(0x1e293b);}
                    pos.setY(i,y); cols.push(c.r,c.g,c.b);
                }
                geo.setAttribute('color',new THREE.Float32BufferAttribute(cols,3)); geo.computeVertexNormals();
                terrainMesh=new THREE.Mesh(geo,new THREE.MeshStandardMaterial({vertexColors:true,roughness:0.9})); terrainMesh.receiveShadow=true; scene.add(terrainMesh);

                ball=new THREE.Mesh(new THREE.SphereGeometry(2,16,16),new THREE.MeshStandardMaterial({color:0xffffff,emissive:0x222222})); ball.castShadow=true; scene.add(ball);
                resetBall();

                if(GameApp.mode==='MULTI') {
                    ghostBall=new THREE.Mesh(new THREE.SphereGeometry(2,16,16),new THREE.MeshBasicMaterial({color:0xff0000,wireframe:true}));
                    ghostBall.position.copy(ball.position); scene.add(ghostBall);
                }

                const pole=new THREE.Mesh(new THREE.CylinderGeometry(0.5,0.5,30),new THREE.MeshLambertMaterial({color:0xffffff}));
                pole.position.set(d.holePos.x,getTerrainHeight(d.holePos.x,d.holePos.z)+15,d.holePos.z);
                const fl=new THREE.Mesh(new THREE.BoxGeometry(10,6,0.5),new THREE.MeshLambertMaterial({color:0xff0000}));
                fl.position.set(5,12,0); pole.add(fl); scene.add(pole);

                const dir=new THREE.Vector3().subVectors(d.holePos,d.startPos).normalize();
                aimAngle=Math.atan2(-dir.x,-dir.z); orbitAngle=aimAngle; setTimeout(drawMinimap,500);
            }

            function updateGhostBall(pos){if(ghostBall)ghostBall.position.set(pos.x,pos.y,pos.z);}
            const rc=new THREE.Raycaster(), dn=new THREE.Vector3(0,-1,0);
            function getTerrainHeight(x,z){if(!terrainMesh)return 0;rc.set(new THREE.Vector3(x,1000,z),dn);const h=rc.intersectObject(terrainMesh);return h.length>0?h[0].point.y:0;}
            function getTerrainNormal(x,z){if(!terrainMesh)return new THREE.Vector3(0,1,0);rc.set(new THREE.Vector3(x,1000,z),dn);const h=rc.intersectObject(terrainMesh);return h.length>0?h[0].face.normal:new THREE.Vector3(0,1,0);}

            function animate() {
                requestAnimationFrame(animate); if(!stageData)return;
                const camDir = physics.moving ? orbitAngle : aimAngle;
                const wa = Math.atan2(windVector.x, windVector.z);
                document.getElementById('wind-arrow').style.transform = `rotate(${wa - camDir}rad)`;

                if(!GameApp.myTurn) {
                    if(ghostBall) {
                        const dist=60; const ct=new THREE.Vector3(ghostBall.position.x-Math.sin(orbitAngle)*-dist,ghostBall.position.y+30,ghostBall.position.z-Math.cos(orbitAngle)*-dist);
                        camera.position.lerp(ct,0.1); camera.lookAt(ghostBall.position);
                    }
                } else {
                    if(!physics.moving){ if(keys.a)aimAngle+=0.04; if(keys.d)aimAngle-=0.04; }
                    if(gaugeState>0) {
                        gaugeAnim.pos+=3.0*gaugeAnim.dir; if(gaugeAnim.pos>=100||gaugeAnim.pos<=0)gaugeAnim.dir*=-1;
                        const c=document.getElementById('gauge-cursor');
                        if(c){
                            if(gaugeState===1) {document.getElementById('gauge-power-fill').style.width=gaugeAnim.pos+'%';c.style.left=gaugeAnim.pos+'%';SoundMgr.charge(gaugeAnim.pos);}
                            else if(gaugeState===2) {document.getElementById('gauge-height-fill').style.height=gaugeAnim.pos+'%';document.getElementById('gauge-height-cursor').style.bottom=gaugeAnim.pos+'%';}
                            else if(gaugeState===3) {c.style.left=gaugeAnim.pos+'%';}
                        }
                    }
                }

                if(physics.moving) {
                    const dt=0.016, steps=4, sDt=dt/steps; let sync=0;
                    for(let s=0; s<steps; s++) {
                        physics.vel.y -= (9.8*stageData.gravity)*sDt;
                        if(ball.position.y>getTerrainHeight(ball.position.x,ball.position.z)+5) physics.vel.add(windVector.clone().multiplyScalar(sDt*0.1));
                        let np=ball.position.clone().add(physics.vel.clone().multiplyScalar(sDt*20.0));
                        let cp=pathLut[0], md=Infinity;
                        for(let k=0;k<pathLut.length;k+=5){const d=(np.x-pathLut[k].x)**2+(np.z-pathLut[k].z)**2;if(d<md){md=d;cp=pathLut[k];}}
                        if(Math.sqrt(md)>stageData.width*2.5){ physics.vel.x*=-0.5; physics.vel.z*=-0.5; np.add(new THREE.Vector3().subVectors(cp,np).normalize().multiplyScalar(10)); SoundMgr.bounce(50); }
                        const gy=getTerrainHeight(np.x,np.z);
                        if(np.y<=gy+2){
                            np.y=gy+2; const n=getTerrainNormal(np.x,np.z);
                            if(physics.vel.y<0){ const d=physics.vel.dot(n); physics.vel.add(n.clone().multiplyScalar(-2*d).multiplyScalar(0.6)); if(physics.vel.length()>5)SoundMgr.bounce(physics.vel.length()); }
                            const f=isPutting?0.96:0.985; physics.vel.x*=f; physics.vel.z*=f;
                            if(physics.vel.length()<2 && Math.abs(ball.position.y-(gy+2))<1){
                                physics.vel.set(0,0,0); physics.moving=false; 
                                if(GameApp.mode==='MULTI'){ GameApp.sendTurnEnd(shots); GameApp.handleBotTurn(); }
                                checkWin(); break;
                            }
                        }
                        const dh=np.distanceTo(new THREE.Vector3(stageData.holePos.x,np.y,stageData.holePos.z));
                        if(dh<3.0){
                            physics.vel.add(new THREE.Vector3().subVectors(new THREE.Vector3(stageData.holePos.x,np.y,stageData.holePos.z),np).normalize().multiplyScalar(2*sDt));
                            if(dh<1.0 && physics.vel.length()<30){ physics.vel.set(0,0,0); physics.moving=false; GameApp.finishStage(shots); break; }
                        }
                        ball.position.copy(np);
                        if(s===0) updateTrail(ball.position);
                        if(ball.position.y<-100){ resetBall(); break; }
                    }
                    sync++; if(sync>5){GameApp.sendPosUpdate(ball.position); sync=0;}
                }

                let ct;
                if(isPutting && GameApp.myTurn){
                    const th=new THREE.Vector3().subVectors(stageData.holePos,ball.position).normalize();
                    const cp=ball.position.clone().sub(th.multiplyScalar(20)); cp.y+=10; camera.position.lerp(cp,0.1); camera.lookAt(stageData.holePos);
                } else if(GameApp.myTurn) {
                    const dist=60;
                    if(physics.moving) ct=new THREE.Vector3(ball.position.x-Math.sin(orbitAngle)*-dist,ball.position.y+30,ball.position.z-Math.cos(orbitAngle)*-dist);
                    else ct=new THREE.Vector3(ball.position.x-Math.sin(aimAngle)*-dist,ball.position.y+30,ball.position.z-Math.cos(aimAngle)*-dist);
                    camera.position.lerp(ct,0.1); camera.lookAt(ball.position);
                }
                updateMinimap(); renderer.render(scene,camera);
            }

            function updateTrail(pos) {
                trailPts.push(pos.clone()); if(trailPts.length>50)trailPts.shift();
                if(trailMesh)scene.remove(trailMesh);
                trailMesh=new THREE.Line(new THREE.BufferGeometry().setFromPoints(trailPts),new THREE.LineBasicMaterial({color:0x4ade80,linewidth:2})); scene.add(trailMesh);
            }

            let glock=false;
            function triggerSpace(){
                if(physics.moving||glock || !GameApp.myTurn)return; glock=true; setTimeout(()=>{glock=false;},200);
                const st=document.getElementById('gauge-status');
                if(isPutting){
                    if(gaugeState===0){gaugeState=1;gaugeAnim.pos=0;gaugeAnim.dir=1;st.innerText="PUTTING: POWER";}
                    else if(gaugeState===1){gaugeVals.p=gaugeAnim.pos;gaugeState=3;shoot();}
                } else {
                    if(gaugeState===0){gaugeState=1;gaugeAnim.pos=0;gaugeAnim.dir=1;st.innerText="TAP: POWER";}
                    else if(gaugeState===1){gaugeVals.p=gaugeAnim.pos;gaugeState=2;gaugeAnim.pos=0;gaugeAnim.dir=1;st.innerText="TAP: HEIGHT";}
                    else if(gaugeState===2){gaugeVals.h=gaugeAnim.pos;gaugeState=3;gaugeAnim.pos=50;gaugeAnim.dir=1;st.innerText="TAP: CURVE";}
                    else if(gaugeState===3){gaugeVals.c=(gaugeAnim.pos-50)/50;shoot();}
                }
            }

            function shoot(){
                gaugeState=0; shots++; SoundMgr.shot();
                document.getElementById('hud-shots').innerText=shots;
                document.getElementById('gauge-container-group').style.display='none';
                let p,ang,cur,fa;
                if(isPutting){ p=gaugeVals.p/100*40; ang=0; cur=0; fa=aimAngle; physics.vel.set(-Math.sin(aimAngle)*p,0,-Math.cos(aimAngle)*p); } 
                else {
                    p=gaugeVals.p/100*80; ang=(15+(gaugeVals.h/100)*60)*(Math.PI/180); cur=gaugeVals.c*0.5; fa=aimAngle+cur;
                    physics.vel.set(-Math.sin(fa)*p*Math.cos(ang),p*Math.sin(ang),-Math.cos(fa)*p*Math.cos(ang));
                }
                physics.moving=true; orbitAngle=aimAngle;
            }

            function resetBall(){
                if(!stageData)return; physics.vel.set(0,0,0); physics.moving=false;
                const y=getTerrainHeight(stageData.startPos.x,stageData.startPos.z);
                ball.position.set(stageData.startPos.x,y+2,stageData.startPos.z);
                updatePuttingState();
            }

            function checkWin(){ updatePuttingState(); }
            
            function updatePuttingState(){
                const d=ball.position.distanceTo(new THREE.Vector3(stageData.holePos.x,ball.position.y,stageData.holePos.z));
                const wp=isPutting; isPutting=(d<30);
                const g=document.getElementById('gauge-container-group'); const s=document.getElementById('gauge-status');
                g.style.display=(GameApp.myTurn)?'flex':'none';
                if(isPutting){
                    if(!wp){ if(!gridHelper){gridHelper=new THREE.GridHelper(60,20,0x4ade80,0x22c55e);gridHelper.position.set(stageData.holePos.x,getTerrainHeight(stageData.holePos.x,stageData.holePos.z)+0.2,stageData.holePos.z);scene.add(gridHelper);} const th=new THREE.Vector3().subVectors(stageData.holePos,ball.position).normalize(); aimAngle=Math.atan2(-th.x,-th.z); }
                    g.classList.add('putting-active'); s.innerText="PUTTING MODE";
                } else {
                    g.classList.remove('putting-active'); s.innerText="TAP: POWER";
                    if(gridHelper){scene.remove(gridHelper);gridHelper=null;}
                }
                document.getElementById('gauge-power-fill').style.width='0%'; document.getElementById('gauge-height-fill').style.height='0%'; gaugeState=0;
            }

            function startTurn() { updatePuttingState(); } // EXPOSED METHOD

            function drawMinimap() {
                if(!miniCtx||!stageData)return; miniCtx.fillStyle='#000'; miniCtx.fillRect(0,0,300,300);
                if(pathLut.length>0){
                    miniCtx.lineWidth=20; miniCtx.lineCap='round'; miniCtx.strokeStyle='#22c55e'; miniCtx.beginPath();
                    const s=300/4000, o=2000; pathLut.forEach((p,i)=>{const x=(p.x+o)*s,y=(p.z+o)*s;if(i===0)miniCtx.moveTo(x,y);else miniCtx.lineTo(x,y);}); miniCtx.stroke();
                }
                const s=300/4000, o=2000;
                const sx=(stageData.startPos.x+o)*s, sz=(stageData.startPos.z+o)*s;
                const hx=(stageData.holePos.x+o)*s, hz=(stageData.holePos.z+o)*s;
                miniCtx.fillStyle='#fff'; miniCtx.beginPath(); miniCtx.arc(sx,sz,4,0,Math.PI*2); miniCtx.fill();
                miniCtx.fillStyle='#ef4444'; miniCtx.beginPath(); miniCtx.arc(hx,hz,6,0,Math.PI*2); miniCtx.fill();
                minimapBg=miniCtx.getImageData(0,0,300,300);
            }
            function updateMinimap() {
                if(!minimapBg||!miniCtx)return; miniCtx.putImageData(minimapBg,0,0);
                const s=300/4000, o=2000;
                const bx=(ball.position.x+o)*s, bz=(ball.position.z+o)*s;
                miniCtx.fillStyle='#fff'; miniCtx.beginPath(); miniCtx.arc(bx,bz,3,0,Math.PI*2); miniCtx.fill();
                if(ghostBall){const rx=(ghostBall.position.x+o)*s, rz=(ghostBall.position.z+o)*s; miniCtx.fillStyle='#ff0000'; miniCtx.beginPath(); miniCtx.arc(rx,rz,3,0,Math.PI*2); miniCtx.fill();}
            }

            function setKey(k,v) { keys[k]=v; }
            return {init,initStage,resetBall,setKey,triggerSpace,updateGhostBall,startTurn};
        })();

        Object.freeze(PlanetDB);
        window.onload=()=>GameApp.init();
    </script>
</body>
</html>
